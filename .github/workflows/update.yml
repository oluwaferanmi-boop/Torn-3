name: Update Leaderboard

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger button
  push:
    branches: [main]

# ============================================
# CONFIGURATION - EDIT THESE DATES
# ============================================
env:
  COMPETITION_START: "2025-12-18"
  COMPETITION_END: "2025-12-31"
  API_URL: "https://api.torn.com/v2/faction/contributors?stat=gymenergy&cat=current&comment=Olu"
# ============================================

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Fetch Data and Build Page
        env:
          API_KEY: ${{ secrets.TORN_API_KEY }}
        run: |
          set -e  # Exit on any error
          
          echo "================================================"
          echo "Starting leaderboard update"
          echo "================================================"
          echo "Competition Start: $COMPETITION_START"
          echo "Competition End: $COMPETITION_END"
          echo "Current Time: $(date -u)"
          echo ""
          
          # Check if API key exists
          if [ -z "$API_KEY" ]; then
            echo "ERROR: TORN_API_KEY secret is not set!"
            echo "Go to Settings > Secrets and variables > Actions"
            echo "Add a secret named TORN_API_KEY with your API key"
            exit 1
          fi
          echo "‚úì API key found"
          
          # Check if competition has ended
          TODAY=$(date +%Y-%m-%d)
          echo "Today's date: $TODAY"
          
          if [[ "$TODAY" > "$COMPETITION_END" ]]; then
            echo "‚ö†Ô∏è  Competition has ended. Skipping data fetch."
            STATUS="üèÅ Competition Ended"
            STATUS_COLOR="rgba(255,71,87,0.8)"
            SKIP_FETCH=true
          else
            echo "‚úì Competition is active"
            STATUS="üî• Competition Active"
            STATUS_COLOR="rgba(39,174,96,0.8)"
            SKIP_FETCH=false
          fi
          echo ""
          
          # Fetch data from API (unless competition ended)
          if [ "$SKIP_FETCH" = false ]; then
            echo "Fetching data from Torn API..."
            HTTP_CODE=$(curl -s -w "%{http_code}" -o data.json "${API_URL}&key=${API_KEY}")
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "ERROR: API request failed with HTTP code $HTTP_CODE"
              if [ -f data.json ]; then
                echo "Response body:"
                cat data.json
              fi
              exit 1
            fi
            echo "‚úì API request successful (HTTP $HTTP_CODE)"
            
            # Check if response is valid JSON
            if ! jq empty data.json 2>/dev/null; then
              echo "ERROR: Invalid JSON response from API"
              echo "Response content:"
              cat data.json
              exit 1
            fi
            echo "‚úì Valid JSON received"
            
            # Check if contributors exist
            CONTRIBUTOR_COUNT=$(jq '.contributors | length' data.json)
            if [ "$CONTRIBUTOR_COUNT" -eq 0 ]; then
              echo "WARNING: No contributors found in API response"
            else
              echo "‚úì Found $CONTRIBUTOR_COUNT contributors"
            fi
            echo ""
          else
            # Use existing data if competition ended
            if [ ! -f data.json ]; then
              echo "ERROR: Competition ended but no previous data.json found"
              exit 1
            fi
            echo "Using existing data.json (competition ended)"
          fi
          
          # Generate HTML page
          echo "Building HTML page..."
          
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Gym Energy Leaderboard</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
              }
              .container { max-width: 900px; margin: 0 auto; }
              .header {
                text-align: center;
                color: white;
                margin-bottom: 30px;
              }
              .header h1 { font-size: 2.5em; margin-bottom: 10px; }
              .status {
                background: STATUS_COLOR_PLACEHOLDER;
                padding: 10px 20px;
                border-radius: 20px;
                display: inline-block;
                margin-top: 10px;
                font-weight: bold;
              }
              .competition-dates {
                color: rgba(255,255,255,0.9);
                margin-top: 10px;
                font-size: 0.9em;
              }
              .podium {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
              }
              .podium-item {
                background: white;
                border-radius: 15px;
                padding: 25px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                transition: transform 0.3s;
              }
              .podium-item:hover { transform: translateY(-5px); }
              .podium-item:first-child {
                background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
              }
              .rank { font-size: 3em; margin-bottom: 10px; }
              .username { font-size: 1.4em; font-weight: bold; margin-bottom: 5px; }
              .energy { font-size: 1.8em; color: #667eea; font-weight: bold; margin-top: 5px; }
              .podium-item:first-child .energy { color: #fff; }
              .table-container {
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                overflow-x: auto;
              }
              table { width: 100%; border-collapse: collapse; }
              th, td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #eee; }
              th { background: #f8f9fa; font-weight: bold; color: #667eea; position: sticky; top: 0; }
              tr:hover { background: #f8f9fa; }
              .rank-col { width: 80px; text-align: center; font-weight: bold; font-size: 1.1em; }
              .energy-col { text-align: right; font-weight: bold; color: #667eea; }
              .updated { 
                text-align: center; 
                color: white; 
                margin-top: 20px; 
                font-size: 0.9em;
                background: rgba(0,0,0,0.2);
                padding: 10px;
                border-radius: 10px;
              }
              .zero-energy { opacity: 0.5; }
              @media (max-width: 768px) {
                .header h1 { font-size: 1.8em; }
                .podium { grid-template-columns: 1fr; }
                th, td { padding: 10px 5px; font-size: 0.9em; }
                .rank { font-size: 2em; }
                .username { font-size: 1.1em; }
                .energy { font-size: 1.3em; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üèãÔ∏è Gym Energy Leaderboard</h1>
                <div class="status">STATUS_PLACEHOLDER</div>
                <div class="competition-dates">DATES_PLACEHOLDER</div>
              </div>
              
              <div class="podium">
          PODIUM_PLACEHOLDER
              </div>
              
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th class="rank-col">Rank</th>
                      <th>Username</th>
                      <th class="energy-col">Energy Spent</th>
                    </tr>
                  </thead>
                  <tbody>
          TABLE_PLACEHOLDER
                  </tbody>
                </table>
              </div>
              
              <div class="updated">
                Last updated: TIMESTAMP_PLACEHOLDER<br>
                Next update: NEXT_UPDATE_PLACEHOLDER
              </div>
            </div>
          </body>
          </html>
          HTMLEOF
          
          echo "‚úì HTML template created"
          
          # Sort contributors by energy (descending) and build HTML
          echo "Processing contributor data..."
          PODIUM=""
          TABLE=""
          RANK=1
          MEDALS=("ü•á" "ü•à" "ü•â")
          ACTIVE_CONTRIBUTORS=0
          
          # Process each contributor
          while IFS= read -r row; do
            USERNAME=$(echo "$row" | jq -r '.username')
            VALUE=$(echo "$row" | jq -r '.value')
            
            # Skip if invalid data
            if [ -z "$USERNAME" ] || [ "$USERNAME" = "null" ]; then
              continue
            fi
            
            # Format number with commas
            FORMATTED=$(printf "%'d" $VALUE 2>/dev/null || echo $VALUE)
            
            # Track active contributors (value > 0)
            if [ "$VALUE" -gt 0 ]; then
              ACTIVE_CONTRIBUTORS=$((ACTIVE_CONTRIBUTORS + 1))
            fi
            
            # Add to podium (top 3 with energy > 0)
            if [ $RANK -le 3 ] && [ "$VALUE" -gt 0 ]; then
              MEDAL="${MEDALS[$RANK-1]}"
              PODIUM+="<div class=\"podium-item\">"
              PODIUM+="<div class=\"rank\">$MEDAL</div>"
              PODIUM+="<div class=\"username\">$USERNAME</div>"
              PODIUM+="<div class=\"energy\">$FORMATTED</div>"
              PODIUM+="</div>"
            fi
            
            # Add to table (mark zero energy differently)
            if [ "$VALUE" -eq 0 ]; then
              TABLE+="<tr class=\"zero-energy\">"
            else
              TABLE+="<tr>"
            fi
            TABLE+="<td class=\"rank-col\">$RANK</td>"
            TABLE+="<td>$USERNAME</td>"
            TABLE+="<td class=\"energy-col\">$FORMATTED</td>"
            TABLE+="</tr>"
            
            RANK=$((RANK + 1))
          done < <(jq -c '.contributors | sort_by(-.value)[]' data.json)
          
          echo "‚úì Processed $((RANK - 1)) total contributors"
          echo "‚úì $ACTIVE_CONTRIBUTORS active contributors (energy > 0)"
          
          # Handle case where no contributors found
          if [ -z "$PODIUM" ]; then
            PODIUM="<div class=\"podium-item\"><div class=\"username\">No data yet</div></div>"
            echo "‚ö†Ô∏è  No active contributors found"
          fi
          
          if [ -z "$TABLE" ]; then
            TABLE="<tr><td colspan=\"3\" style=\"text-align:center;\">No contributors found</td></tr>"
          fi
          
          # Calculate next update time
          NEXT_UPDATE=$(date -u -d "+6 hours" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "In 6 hours")
          
          # Replace placeholders in HTML
          TIMESTAMP=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          DATES="$COMPETITION_START to $COMPETITION_END"
          
          sed -i "s|STATUS_PLACEHOLDER|$STATUS|g" index.html
          sed -i "s|STATUS_COLOR_PLACEHOLDER|$STATUS_COLOR|g" index.html
          sed -i "s|DATES_PLACEHOLDER|$DATES|g" index.html
          sed -i "s|PODIUM_PLACEHOLDER|$PODIUM|g" index.html
          sed -i "s|TABLE_PLACEHOLDER|$TABLE|g" index.html
          sed -i "s|TIMESTAMP_PLACEHOLDER|$TIMESTAMP|g" index.html
          sed -i "s|NEXT_UPDATE_PLACEHOLDER|$NEXT_UPDATE|g" index.html
          
          echo "‚úì HTML page built successfully"
          echo ""
          echo "Preview of top 3:"
          jq -r '.contributors | sort_by(-.value) | .[:3][] | "  \(.username): \(.value)"' data.json || echo "  (none)"
          
      - name: Commit and Push Changes
        run: |
          echo ""
          echo "================================================"
          echo "Deploying to GitHub Pages"
          echo "================================================"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add index.html data.json
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "Update leaderboard - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "‚úì Changes pushed successfully"
          fi
          
          echo ""
          echo "================================================"
          echo "Update complete!"
          echo "================================================"
          echo "Your leaderboard is live at:"
          echo "https://$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]' | sed 's/\//.github.io\//')"
          echo "================================================"
